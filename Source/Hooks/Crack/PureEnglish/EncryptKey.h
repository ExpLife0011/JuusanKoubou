#include "Common.h"

VOID InitKey(PULONG Key, ULONG_PTR KeySize, ULONG_PTR Mask)
{
    FOR_EACH(Key, Key, KeySize)
    {
        *Key -= Mask;
    }
}

VOID EncryptBuffer(Cxdec &cxdec, PBYTE Buffer, ULONG_PTR Size, PULONG EncryptKey)
{
    ULONG_PTR Index;

    Index = 0;
    Buffer = (PBYTE)Buffer;
    for (ULONG_PTR Count = Size; Count; --Count)
    {
        *Buffer++ ^= Index++;
    }

    cxdec.Encrypt2(0, Buffer - Size, Size, EncryptKey);
}

VOID DecryptBuffer(Cxdec &cxdec, PBYTE Buffer, ULONG_PTR Size, PULONG DecryptKey)
{
    ULONG_PTR Index;

    Buffer = (PBYTE)Buffer;
    cxdec.Decrypt2(0, Buffer, Size, DecryptKey);

    Index = 0;
    for (ULONG_PTR Count = Size; Count; --Count)
    {
        *Buffer++ ^= Index++;
    }
}

ULONG StaticEncryptKey[0x400] =
{
    0x00000000, 0x77073096, 0xee0e612c, 0x990951ba, 0x076dc419, 0x706af48f, 0xe963a535, 0x9e6495a3, 0x0edb8832, 0x79dcb8a4, 0xe0d5e91e, 0x97d2d988, 0x09b64c2b, 0x7eb17cbd, 0xe7b82d07, 0x90bf1d91,
    0x1db71064, 0x6ab020f2, 0xf3b97148, 0x84be41de, 0x1adad47d, 0x6ddde4eb, 0xf4d4b551, 0x83d385c7, 0x136c9856, 0x646ba8c0, 0xfd62f97a, 0x8a65c9ec, 0x14015c4f, 0x63066cd9, 0xfa0f3d63, 0x8d080df5,
    0x3b6e20c8, 0x4c69105e, 0xd56041e4, 0xa2677172, 0x3c03e4d1, 0x4b04d447, 0xd20d85fd, 0xa50ab56b, 0x35b5a8fa, 0x42b2986c, 0xdbbbc9d6, 0xacbcf940, 0x32d86ce3, 0x45df5c75, 0xdcd60dcf, 0xabd13d59,
    0x26d930ac, 0x51de003a, 0xc8d75180, 0xbfd06116, 0x21b4f4b5, 0x56b3c423, 0xcfba9599, 0xb8bda50f, 0x2802b89e, 0x5f058808, 0xc60cd9b2, 0xb10be924, 0x2f6f7c87, 0x58684c11, 0xc1611dab, 0xb6662d3d,
    0x76dc4190, 0x01db7106, 0x98d220bc, 0xefd5102a, 0x71b18589, 0x06b6b51f, 0x9fbfe4a5, 0xe8b8d433, 0x7807c9a2, 0x0f00f934, 0x9609a88e, 0xe10e9818, 0x7f6a0dbb, 0x086d3d2d, 0x91646c97, 0xe6635c01,
    0x6b6b51f4, 0x1c6c6162, 0x856530d8, 0xf262004e, 0x6c0695ed, 0x1b01a57b, 0x8208f4c1, 0xf50fc457, 0x65b0d9c6, 0x12b7e950, 0x8bbeb8ea, 0xfcb9887c, 0x62dd1ddf, 0x15da2d49, 0x8cd37cf3, 0xfbd44c65,
    0x4db26158, 0x3ab551ce, 0xa3bc0074, 0xd4bb30e2, 0x4adfa541, 0x3dd895d7, 0xa4d1c46d, 0xd3d6f4fb, 0x4369e96a, 0x346ed9fc, 0xad678846, 0xda60b8d0, 0x44042d73, 0x33031de5, 0xaa0a4c5f, 0xdd0d7cc9,
    0x5005713c, 0x270241aa, 0xbe0b1010, 0xc90c2086, 0x5768b525, 0x206f85b3, 0xb966d409, 0xce61e49f, 0x5edef90e, 0x29d9c998, 0xb0d09822, 0xc7d7a8b4, 0x59b33d17, 0x2eb40d81, 0xb7bd5c3b, 0xc0ba6cad,
    0xedb88320, 0x9abfb3b6, 0x03b6e20c, 0x74b1d29a, 0xead54739, 0x9dd277af, 0x04db2615, 0x73dc1683, 0xe3630b12, 0x94643b84, 0x0d6d6a3e, 0x7a6a5aa8, 0xe40ecf0b, 0x9309ff9d, 0x0a00ae27, 0x7d079eb1,
    0xf00f9344, 0x8708a3d2, 0x1e01f268, 0x6906c2fe, 0xf762575d, 0x806567cb, 0x196c3671, 0x6e6b06e7, 0xfed41b76, 0x89d32be0, 0x10da7a5a, 0x67dd4acc, 0xf9b9df6f, 0x8ebeeff9, 0x17b7be43, 0x60b08ed5,
    0xd6d6a3e8, 0xa1d1937e, 0x38d8c2c4, 0x4fdff252, 0xd1bb67f1, 0xa6bc5767, 0x3fb506dd, 0x48b2364b, 0xd80d2bda, 0xaf0a1b4c, 0x36034af6, 0x41047a60, 0xdf60efc3, 0xa867df55, 0x316e8eef, 0x4669be79,
    0xcb61b38c, 0xbc66831a, 0x256fd2a0, 0x5268e236, 0xcc0c7795, 0xbb0b4703, 0x220216b9, 0x5505262f, 0xc5ba3bbe, 0xb2bd0b28, 0x2bb45a92, 0x5cb36a04, 0xc2d7ffa7, 0xb5d0cf31, 0x2cd99e8b, 0x5bdeae1d,
    0x9b64c2b0, 0xec63f226, 0x756aa39c, 0x026d930a, 0x9c0906a9, 0xeb0e363f, 0x72076785, 0x05005713, 0x95bf4a82, 0xe2b87a14, 0x7bb12bae, 0x0cb61b38, 0x92d28e9b, 0xe5d5be0d, 0x7cdcefb7, 0x0bdbdf21,
    0x86d3d2d4, 0xf1d4e242, 0x68ddb3f8, 0x1fda836e, 0x81be16cd, 0xf6b9265b, 0x6fb077e1, 0x18b74777, 0x88085ae6, 0xff0f6a70, 0x66063bca, 0x11010b5c, 0x8f659eff, 0xf862ae69, 0x616bffd3, 0x166ccf45,
    0xa00ae278, 0xd70dd2ee, 0x4e048354, 0x3903b3c2, 0xa7672661, 0xd06016f7, 0x4969474d, 0x3e6e77db, 0xaed16a4a, 0xd9d65adc, 0x40df0b66, 0x37d83bf0, 0xa9bcae53, 0xdebb9ec5, 0x47b2cf7f, 0x30b5ffe9,
    0xbdbdf21c, 0xcabac28a, 0x53b39330, 0x24b4a3a6, 0xbad03605, 0xcdd70693, 0x54de5729, 0x23d967bf, 0xb3667a2e, 0xc4614ab8, 0x5d681b02, 0x2a6f2b94, 0xb40bbe37, 0xc30c8ea1, 0x5a05df1b, 0x2d02ef8d,

    0x4ccdcd00, 0x4ccdcd81, 0x140c0c00, 0x140c0c18, 0x35131300, 0x35131326, 0x2fecec00, 0x2fececc3, 0xe15f5f00, 0xe15f5fbe, 0xa2979700, 0xa2979735, 0xcc444400, 0xcc444488, 0x39171700, 0x3917172e,
    0x57c4c400, 0x57c4c493, 0xf2a7a700, 0xf2a7a755, 0x827e7e00, 0x827e7efc, 0x473d3d00, 0x473d3d7a, 0xac646400, 0xac6464c8, 0xe75d5d00, 0xe75d5dba, 0x2b191900, 0x2b191932, 0x95737300, 0x957373e6,
    0xa0606000, 0xa06060c0, 0x98818100, 0x98818119, 0xd14f4f00, 0xd14f4f9e, 0x7fdcdc00, 0x7fdcdca3, 0x66222200, 0x66222244, 0x7e2a2a00, 0x7e2a2a54, 0xab909000, 0xab90903b, 0x83888800, 0x8388880b,
    0xca464600, 0xca46468c, 0x29eeee00, 0x29eeeec7, 0xd3b8b800, 0xd3b8b86b, 0x3c141400, 0x3c141428, 0x79dede00, 0x79dedea7, 0xe25e5e00, 0xe25e5ebc, 0x1d0b0b00, 0x1d0b0b16, 0x76dbdb00, 0x76dbdbad,
    0x3be0e000, 0x3be0e0db, 0x56323200, 0x56323264, 0x4e3a3a00, 0x4e3a3a74, 0x1e0a0a00, 0x1e0a0a14, 0xdb494900, 0xdb494992, 0x0a060600, 0x0a06060c, 0x6c242400, 0x6c242448, 0xe45c5c00, 0xe45c5cb8,
    0x5dc2c200, 0x5dc2c29f, 0x6ed3d300, 0x6ed3d3bd, 0xefacac00, 0xefacac43, 0xa6626200, 0xa66262c4, 0xa8919100, 0xa8919139, 0xa4959500, 0xa4959531, 0x37e4e400, 0x37e4e4d3, 0x8b797900, 0x8b7979f2,
    0x32e7e700, 0x32e7e7d5, 0x43c8c800, 0x43c8c88b, 0x59373700, 0x5937376e, 0xb76d6d00, 0xb76d6dda, 0x8c8d8d00, 0x8c8d8d01, 0x64d5d500, 0x64d5d5b1, 0xd24e4e00, 0xd24e4e9c, 0xe0a9a900, 0xe0a9a949,
    0xb46c6c00, 0xb46c6cd8, 0xfa565600, 0xfa5656ac, 0x07f4f400, 0x07f4f4f3, 0x25eaea00, 0x25eaeacf, 0xaf656500, 0xaf6565ca, 0x8e7a7a00, 0x8e7a7af4, 0xe9aeae00, 0xe9aeae47, 0x18080800, 0x18080810,
    0xd5baba00, 0xd5baba6f, 0x88787800, 0x887878f0, 0x6f252500, 0x6f25254a, 0x722e2e00, 0x722e2e5c, 0x241c1c00, 0x241c1c38, 0xf1a6a600, 0xf1a6a657, 0xc7b4b400, 0xc7b4b473, 0x51c6c600, 0x51c6c697,
    0x23e8e800, 0x23e8e8cb, 0x7cdddd00, 0x7cdddda1, 0x9c747400, 0x9c7474e8, 0x211f1f00, 0x211f1f3e, 0xdd4b4b00, 0xdd4b4b96, 0xdcbdbd00, 0xdcbdbd61, 0x868b8b00, 0x868b8b0d, 0x858a8a00, 0x858a8a0f,
    0x90707000, 0x907070e0, 0x423e3e00, 0x423e3e7c, 0xc4b5b500, 0xc4b5b571, 0xaa666600, 0xaa6666cc, 0xd8484800, 0xd8484890, 0x05030300, 0x05030306, 0x01f6f600, 0x01f6f6f7, 0x120e0e00, 0x120e0e1c,
    0xa3616100, 0xa36161c2, 0x5f353500, 0x5f35356a, 0xf9575700, 0xf95757ae, 0xd0b9b900, 0xd0b9b969, 0x91868600, 0x91868617, 0x58c1c100, 0x58c1c199, 0x271d1d00, 0x271d1d3a, 0xb99e9e00, 0xb99e9e27,
    0x38e1e100, 0x38e1e1d9, 0x13f8f800, 0x13f8f8eb, 0xb3989800, 0xb398982b, 0x33111100, 0x33111122, 0xbb696900, 0xbb6969d2, 0x70d9d900, 0x70d9d9a9, 0x898e8e00, 0x898e8e07, 0xa7949400, 0xa7949433,
    0xb69b9b00, 0xb69b9b2d, 0x221e1e00, 0x221e1e3c, 0x92878700, 0x92878715, 0x20e9e900, 0x20e9e9c9, 0x49cece00, 0x49cece87, 0xff555500, 0xff5555aa, 0x78282800, 0x78282850, 0x7adfdf00, 0x7adfdfa5,
    0x8f8c8c00, 0x8f8c8c03, 0xf8a1a100, 0xf8a1a159, 0x80898900, 0x80898909, 0x170d0d00, 0x170d0d1a, 0xdabfbf00, 0xdabfbf65, 0x31e6e600, 0x31e6e6d7, 0xc6424200, 0xc6424284, 0xb8686800, 0xb86868d0,
    0xc3414100, 0xc3414182, 0xb0999900, 0xb0999929, 0x772d2d00, 0x772d2d5a, 0x110f0f00, 0x110f0f1e, 0xcbb0b000, 0xcbb0b07b, 0xfc545400, 0xfc5454a8, 0xd6bbbb00, 0xd6bbbb6d, 0x3a161600, 0x3a16162c,
    0xa5636300, 0xa56363c6, 0x847c7c00, 0x847c7cf8, 0x99777700, 0x997777ee, 0x8d7b7b00, 0x8d7b7bf6, 0x0df2f200, 0x0df2f2ff, 0xbd6b6b00, 0xbd6b6bd6, 0xb16f6f00, 0xb16f6fde, 0x54c5c500, 0x54c5c591,
    0x50303000, 0x50303060, 0x03010100, 0x03010102, 0xa9676700, 0xa96767ce, 0x7d2b2b00, 0x7d2b2b56, 0x19fefe00, 0x19fefee7, 0x62d7d700, 0x62d7d7b5, 0xe6abab00, 0xe6abab4d, 0x9a767600, 0x9a7676ec,
    0x45caca00, 0x45caca8f, 0x9d828200, 0x9d82821f, 0x40c9c900, 0x40c9c989, 0x877d7d00, 0x877d7dfa, 0x15fafa00, 0x15fafaef, 0xeb595900, 0xeb5959b2, 0xc9474700, 0xc947478e, 0x0bf0f000, 0x0bf0f0fb,
    0xecadad00, 0xecadad41, 0x67d4d400, 0x67d4d4b3, 0xfda2a200, 0xfda2a25f, 0xeaafaf00, 0xeaafaf45, 0xbf9c9c00, 0xbf9c9c23, 0xf7a4a400, 0xf7a4a453, 0x96727200, 0x967272e4, 0x5bc0c000, 0x5bc0c09b,
    0xc2b7b700, 0xc2b7b775, 0x1cfdfd00, 0x1cfdfde1, 0xae939300, 0xae93933d, 0x6a262600, 0x6a26264c, 0x5a363600, 0x5a36366c, 0x413f3f00, 0x413f3f7e, 0x02f7f700, 0x02f7f7f5, 0x4fcccc00, 0x4fcccc83,
    0x5c343400, 0x5c343468, 0xf4a5a500, 0xf4a5a551, 0x34e5e500, 0x34e5e5d1, 0x08f1f100, 0x08f1f1f9, 0x93717100, 0x937171e2, 0x73d8d800, 0x73d8d8ab, 0x53313100, 0x53313162, 0x3f151500, 0x3f15152a,
    0x0c040400, 0x0c040408, 0x52c7c700, 0x52c7c795, 0x65232300, 0x65232346, 0x5ec3c300, 0x5ec3c39d, 0x28181800, 0x28181830, 0xa1969600, 0xa1969637, 0x0f050500, 0x0f05050a, 0xb59a9a00, 0xb59a9a2f,
    0x09070700, 0x0907070e, 0x36121200, 0x36121224, 0x9b808000, 0x9b80801b, 0x3de2e200, 0x3de2e2df, 0x26ebeb00, 0x26ebebcd, 0x69272700, 0x6927274e, 0xcdb2b200, 0xcdb2b27f, 0x9f757500, 0x9f7575ea,
    0x1b090900, 0x1b090912, 0x9e838300, 0x9e83831d, 0x742c2c00, 0x742c2c58, 0x2e1a1a00, 0x2e1a1a34, 0x2d1b1b00, 0x2d1b1b36, 0xb26e6e00, 0xb26e6edc, 0xee5a5a00, 0xee5a5ab4, 0xfba0a000, 0xfba0a05b,
    0xf6525200, 0xf65252a4, 0x4d3b3b00, 0x4d3b3b76, 0x61d6d600, 0x61d6d6b7, 0xceb3b300, 0xceb3b37d, 0x7b292900, 0x7b292952, 0x3ee3e300, 0x3ee3e3dd, 0x712f2f00, 0x712f2f5e, 0x97848400, 0x97848413,
    0xf5535300, 0xf55353a6, 0x68d1d100, 0x68d1d1b9, 0x00000000, 0x00000000, 0x2ceded00, 0x2cededc1, 0x60202000, 0x60202040, 0x1ffcfc00, 0x1ffcfce3, 0xc8b1b100, 0xc8b1b179, 0xed5b5b00, 0xed5b5bb6,
    0xbe6a6a00, 0xbe6a6ad4, 0x46cbcb00, 0x46cbcb8d, 0xd9bebe00, 0xd9bebe67, 0x4b393900, 0x4b393972, 0xde4a4a00, 0xde4a4a94, 0xd44c4c00, 0xd44c4c98, 0xe8585800, 0xe85858b0, 0x4acfcf00, 0x4acfcf85,
    0x6bd0d000, 0x6bd0d0bb, 0x2aefef00, 0x2aefefc5, 0xe5aaaa00, 0xe5aaaa4f, 0x16fbfb00, 0x16fbfbed, 0xc5434300, 0xc5434386, 0xd74d4d00, 0xd74d4d9a, 0x55333300, 0x55333366, 0x94858500, 0x94858511,
    0xcf454500, 0xcf45458a, 0x10f9f900, 0x10f9f9e9, 0x06020200, 0x06020204, 0x817f7f00, 0x817f7ffe, 0xf0505000, 0xf05050a0, 0x443c3c00, 0x443c3c78, 0xba9f9f00, 0xba9f9f25, 0xe3a8a800, 0xe3a8a84b,
    0xf3515100, 0xf35151a2, 0xfea3a300, 0xfea3a35d, 0xc0404000, 0xc0404080, 0x8a8f8f00, 0x8a8f8f05, 0xad929200, 0xad92923f, 0xbc9d9d00, 0xbc9d9d21, 0x48383800, 0x48383870, 0x04f5f500, 0x04f5f5f1,
    0xdfbcbc00, 0xdfbcbc63, 0xc1b6b600, 0xc1b6b677, 0x75dada00, 0x75dadaaf, 0x63212100, 0x63212142, 0x30101000, 0x30101020, 0x1affff00, 0x1affffe5, 0x0ef3f300, 0x0ef3f3fd, 0x6dd2d200, 0x6dd2d2bf,
    0x4ccdcd00, 0x4ccdcd81, 0x140c0c00, 0x140c0c18, 0x35131300, 0x35131326, 0x2fecec00, 0x2fececc3, 0xe15f5f00, 0xe15f5fbe, 0xa2979700, 0xa2979735, 0xcc444400, 0xcc444488, 0x39171700, 0x3917172e,
    0x57c4c400, 0x57c4c493, 0xf2a7a700, 0xf2a7a755, 0x827e7e00, 0x827e7efc, 0x473d3d00, 0x473d3d7a, 0xac646400, 0xac6464c8, 0xe75d5d00, 0xe75d5dba, 0x2b191900, 0x2b191932, 0x95737300, 0x957373e6,
    0xa0606000, 0xa06060c0, 0x98818100, 0x98818119, 0xd14f4f00, 0xd14f4f9e, 0x7fdcdc00, 0x7fdcdca3, 0x66222200, 0x66222244, 0x7e2a2a00, 0x7e2a2a54, 0xab909000, 0xab90903b, 0x83888800, 0x8388880b,
    0xca464600, 0xca46468c, 0x29eeee00, 0x29eeeec7, 0xd3b8b800, 0xd3b8b86b, 0x3c141400, 0x3c141428, 0x79dede00, 0x79dedea7, 0xe25e5e00, 0xe25e5ebc, 0x1d0b0b00, 0x1d0b0b16, 0x76dbdb00, 0x76dbdbad,
    0x3be0e000, 0x3be0e0db, 0x56323200, 0x56323264, 0x4e3a3a00, 0x4e3a3a74, 0x1e0a0a00, 0x1e0a0a14, 0xdb494900, 0xdb494992, 0x0a060600, 0x0a06060c, 0x6c242400, 0x6c242448, 0xe45c5c00, 0xe45c5cb8,
    0x5dc2c200, 0x5dc2c29f, 0x6ed3d300, 0x6ed3d3bd, 0xefacac00, 0xefacac43, 0xa6626200, 0xa66262c4, 0xa8919100, 0xa8919139, 0xa4959500, 0xa4959531, 0x37e4e400, 0x37e4e4d3, 0x8b797900, 0x8b7979f2,
    0x32e7e700, 0x32e7e7d5, 0x43c8c800, 0x43c8c88b, 0x59373700, 0x5937376e, 0xb76d6d00, 0xb76d6dda, 0x8c8d8d00, 0x8c8d8d01, 0x64d5d500, 0x64d5d5b1, 0xd24e4e00, 0xd24e4e9c, 0xe0a9a900, 0xe0a9a949,
    0xb46c6c00, 0xb46c6cd8, 0xfa565600, 0xfa5656ac, 0x07f4f400, 0x07f4f4f3, 0x25eaea00, 0x25eaeacf, 0xaf656500, 0xaf6565ca, 0x8e7a7a00, 0x8e7a7af4, 0xe9aeae00, 0xe9aeae47, 0x18080800, 0x18080810,
    0xd5baba00, 0xd5baba6f, 0x88787800, 0x887878f0, 0x6f252500, 0x6f25254a, 0x722e2e00, 0x722e2e5c, 0x241c1c00, 0x241c1c38, 0xf1a6a600, 0xf1a6a657, 0xc7b4b400, 0xc7b4b473, 0x51c6c600, 0x51c6c697,
    0x23e8e800, 0x23e8e8cb, 0x7cdddd00, 0x7cdddda1, 0x9c747400, 0x9c7474e8, 0x211f1f00, 0x211f1f3e, 0xdd4b4b00, 0xdd4b4b96, 0xdcbdbd00, 0xdcbdbd61, 0x868b8b00, 0x868b8b0d, 0x858a8a00, 0x858a8a0f,
    0x90707000, 0x907070e0, 0x423e3e00, 0x423e3e7c, 0xc4b5b500, 0xc4b5b571, 0xaa666600, 0xaa6666cc, 0xd8484800, 0xd8484890, 0x05030300, 0x05030306, 0x01f6f600, 0x01f6f6f7, 0x120e0e00, 0x120e0e1c,
    0xa3616100, 0xa36161c2, 0x5f353500, 0x5f35356a, 0xf9575700, 0xf95757ae, 0xd0b9b900, 0xd0b9b969, 0x91868600, 0x91868617, 0x58c1c100, 0x58c1c199, 0x271d1d00, 0x271d1d3a, 0xb99e9e00, 0xb99e9e27,
    0x38e1e100, 0x38e1e1d9, 0x13f8f800, 0x13f8f8eb, 0xb3989800, 0xb398982b, 0x33111100, 0x33111122, 0xbb696900, 0xbb6969d2, 0x70d9d900, 0x70d9d9a9, 0x898e8e00, 0x898e8e07, 0xa7949400, 0xa7949433,
    0xb69b9b00, 0xb69b9b2d, 0x221e1e00, 0x221e1e3c, 0x92878700, 0x92878715, 0x20e9e900, 0x20e9e9c9, 0x49cece00, 0x49cece87, 0xff555500, 0xff5555aa, 0x78282800, 0x78282850, 0x7adfdf00, 0x7adfdfa5,
    0x8f8c8c00, 0x8f8c8c03, 0xf8a1a100, 0xf8a1a159, 0x80898900, 0x80898909, 0x170d0d00, 0x170d0d1a, 0xdabfbf00, 0xdabfbf65, 0x31e6e600, 0x31e6e6d7, 0xc6424200, 0xc6424284, 0xb8686800, 0xb86868d0,
    0xc3414100, 0xc3414182, 0xb0999900, 0xb0999929, 0x772d2d00, 0x772d2d5a, 0x110f0f00, 0x110f0f1e, 0xcbb0b000, 0xcbb0b07b, 0xfc545400, 0xfc5454a8, 0xd6bbbb00, 0xd6bbbb6d, 0x3a161600, 0x3a16162c,
};
